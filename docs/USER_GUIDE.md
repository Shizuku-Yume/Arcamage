# Arcamage 用户手册

本文档面向日常使用者，覆盖最新首页、工作台、AI Agent、Arcaferry 与设置项。

---

## 1. 快速认知

Arcamage 是一个浏览器内角色卡编辑器，核心工作流是：

1. 导入已有卡片或新建空白卡
2. 在工作台编辑字段/世界书
3. 导出 PNG 或 JSON

系统会自动保留草稿，且支持撤销/重做与 AI 辅助修改。

---

## 2. 支持范围

### 2.1 前端页面可直接上传

| 类型 | 导入 | 导出 | 说明 |
|------|:----:|:----:|------|
| PNG（CCv3 / CCv2） | ✅ | ✅ | 推荐主流程，导出会写入元数据 |
| JSON（CCv3 / CCv2） | ✅ | ✅ | 纯数据流程，不包含卡面图片 |

> 说明：后端 `POST /api/cards/parse` 还支持 JPG/WebP/GIF/BMP 等图片转 PNG 后解析，但页面入口当前仍以 PNG/JSON 为主。

### 2.2 核心能力

- 完整 CCv3 字段编辑（含 V2 自动迁移）
- 世界书（Lorebook）可视化管理 + 拖拽排序
- 自动保存草稿 + 草稿恢复
- Token 估算 + 风险提示
- AI Agent（对话、Diff 预览、整轮自动应用 + 最近变更按项撤销）
- Arcaferry 单个抓取 / 批量抓取 / 暂存区编辑

---

## 3. 页面与工作流

### 3.1 首页（Home）

首页有 3 条主入口：

1. **上传卡片**：拖拽或选择 PNG/JSON
2. **新建卡片**：创建空白 CCv3 卡
3. **Arcaferry 导入**：打开导入弹窗抓取卡片

若检测到未完成草稿，会弹窗提示是否恢复。

### 3.2 工作台（Workshop）

工作台是主编辑区域，包含：

- 基础字段（名称、作者、标签等）
- 描述类字段（description / personality / scenario）
- 消息字段（first_mes / alternate_greetings / group_only_greetings / mes_example）
- 系统字段（system_prompt / post_history_instructions / creator_notes）
- 高级区域（character_book / extensions / assets 等）

建议编辑顺序：

1. 先确定角色定位（名字、设定骨架）
2. 再完善描述与对话示例
3. 最后整理世界书并观察 Token 预算

---

## 4. 编辑能力详解

### 4.1 世界书（Lorebook）

世界书编辑器支持：

- 新增、复制、删除条目
- 拖拽排序（SortableJS）
- 启用/禁用、constant、优先级等属性调整
- `keys` / `secondary_keys` 管理
- 导入 JSON（替换或合并）与导出 JSON

### 4.2 自动保存与草稿

- 自动保存启用时，按设置间隔写入浏览器本地存储
- 可在首页自动检测并恢复最近草稿
- 成功导出后会清理当前编辑草稿

### 4.3 Token 估算

- 实时估算整卡与字段 Token 数
- 公式：`CJK 字符 / 0.7 + 非 CJK 字符 / 4`
- 默认预算 8000，告警阈值：
  - `>= 70%`：warning
  - `>= 90%`：danger

### 4.4 文本清洗

内置文本清洗支持：

- 全角转半角
- 零宽字符移除
- 多余空行规整

其中 greeting 相关敏感字段采用更保守策略，必要时会二次确认。

### 4.5 撤销/重做

- 支持撤销、重做
- 历史栈有上限（默认 10 步）

---

## 5. AI Agent 功能

工作台支持 AI Agent 辅助编辑，核心体验包括：

- 对话式修改卡片
- 修改结果以 Diff 形式展示
- 默认整轮应用修改，并支持对最新一轮中的单项变更执行“本项撤销”
- 支持最近一轮整轮撤销，以及最近窗口内从历史消息重试
- 支持预设（Prompt Preset）
- 支持技能（Skill）开关、选择、自动匹配与本地技能管理

如果你更关注可控性，建议先看 Diff 再应用。

---

## 6. Arcaferry 导入

Arcaferry 弹窗包含 4 个标签页：

1. **单个抓取**：输入分享链接抓取单卡
2. **批量抓取**：支持多链接、并发数 1~5
3. **暂存区**：浏览批量结果，支持加载到工作台或直接下载 PNG
4. **参数设置**：服务地址、Token/Cookies/User-Agent/Gemini Key 与记忆选项

如果抓取失败，优先检查：服务连接状态、授权信息、链接有效性。

---

## 7. 设置说明

设置分为四组：

### 7.1 编辑器设置

- 自动保存开关
- 自动保存间隔（5~300 秒）
- 导出时是否包含 V2 兼容块（`chara`）
- 本地存储统计与一键清理

### 7.2 供应商配置

- 支持多个供应商配置（可增删改名）
- API 地址 / API Key / 模型选择
- 代理开关（通过后端转发以规避跨域）
- 温度参数（0.0~2.0）
- 测试连接与拉取模型列表

### 7.3 Agent 功能

- 技能功能开关
- 活动轨迹显示开关
- Diff 显示方式（统一/分屏、换行、折叠）
- 高级参数（工具调用上限、输出长度上限、自动匹配上限）

### 7.4 主题

- 跟随系统 / 浅色 / 深色
- 强调色预设与自定义十六进制颜色

---

## 8. 导出策略

### 导出 PNG（推荐）

- 将角色卡元数据写入 PNG
- 默认可附带 V2 兼容数据
- 适合直接在支持角色卡 PNG 的平台使用

### 导出 JSON

- 导出纯数据，不含图片
- 适合版本管理和文本审阅

工作台顶部会显示状态：`有修改 / 已导出 / 未导出`。

---

## 9. 快捷键

| 快捷键 | 作用 |
|--------|------|
| `Ctrl/Cmd + Z` | 撤销 |
| `Ctrl/Cmd + Shift + Z` | 重做 |
| `Ctrl/Cmd + Y` | 重做（常见 Windows 习惯） |
| `Ctrl/Cmd + S` | 导出 PNG |

> 输入框聚焦时，浏览器优先处理原生编辑快捷键。

---

## 10. 常见问题

### Q1：导入 PNG 但没有读取到角色信息

可能原因：

- 图片不含 `ccv3` / `chara` 元数据
- 元数据损坏或结构不符合规范

建议先尝试导入对应 JSON。

### Q2：Token 估算和模型实际不一致

估算是容量预警，不是精确 tokenizer 计费结果。

### Q3：Arcaferry 批量抓取成功率不稳定

建议检查：

- Arcaferry 服务是否在线
- Token/Cookies/User-Agent 是否匹配
- 并发数是否过高（可降到 1~2）

### Q4：想彻底清理浏览器侧数据

在设置里使用“清空本地存储”，随后刷新页面。

---

## 11. 相关文档

- [快速开始](QUICKSTART.md)
- [API 文档](API.md)
- [部署指南](DEPLOYMENT.md)
